<html>
  <head>
    <title>Image Tools</title>
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
      canvas {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        border: 1px solid #ededed;
      }
      label input[type="file"] {
        display: none;
      }
      body > .container-fluid {
        padding-left: 0;
        padding-right: 0;
        overflow-x: hidden;
      }
      .navbar-btn {
        margin-right: 8px;
      }
      .navbar-btn:last-child {
        margin-right: 0;
      }
      .form-inline input {
        max-width: 90px;
      }
      .panel-primary .panel-heading {
        cursor: pointer;
      }
      .well {
        margin-bottom: 0;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <span class="navbar-brand">Image tools</span>
        </div>
        <div class="navbar-collapse">
          <div class="navbar-right">
            <label for="file" class="btn btn-default navbar-btn">
              Choose a file
              <input type="file" accept="image/*" id="file" />
            </label>
            <button class="btn btn-primary navbar-btn">Export</button>
          </div>
        </div>
      </div>
    </nav>
    <div class="container-fluid">
      <div class="row">      
        <div class="col-sm-4 col-md-3">
          <div class="well">
  
            <div class="panel panel-primary">
              <div class="panel-heading" data-toggle="collapse" data-target="#collapseDimension" aria-expanded="true" aria-controls="collapseDimension">
                <h4 class="panel-title">
                  Size & position
                </h4>
              </div>
              <div class="panel-body collapse in" id="collapseDimension">
                <div class="form-group">
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-default" id="imgPosTop">Top</button>
                    <button type="button" class="btn btn-default" id="imgPosRight">Right</button>
                    <button type="button" class="btn btn-default" id="imgPosBottom">Bottom</button>
                    <button type="button" class="btn btn-default" id="imgPosLeft">Left</button>                
                  </div>
  
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-default" id="imgPosCenter">Horizontal center</button>
                    <button type="button" class="btn btn-default" id="imgPosVCenter">Vertical center</button>
                  </div>
                </div>

                <div class="form-group">
                  <label>Working plan size: </label>
                  <div class="form-inline">
                    <input class="form-control" type="number" id="canvasW" placeholder="width"/>
                    x
                    <input class="form-control" type="number" id="canvasH" placeholder="height"/>
                    pixels
                  </div>
                </div>
  
                <div class="form-group">
                  <label>Image size: </label>
                  <div class="form-inline">
                    <input class="form-control" type="number" id="imgW" placeholder="width"/>
                    x
                    <input class="form-control" type="number" id="imgH" placeholder="height"/>
                    pixels
                  </div>
                  <div class="checkbox">
                    <label for="aspectRatio">
                      <input type="checkbox" id="aspectRatio"/>
                      &nbsp;
                      keep aspect ratio
                    </label>
                  </div>
                </div>
  
                <div class="form-group">
                  <label>Image positions: </label>
                  <div class="form-inline">
                    <input class="form-control" type="number" id="imgPosX" placeholder="X"/>
                    <input class="form-control" type="number" id="imgPosY" placeholder="Y"/>
                    pixels
                  </div>
                </div>

                <div class="form-group">
                  <label>Image rotation: </label>
                  <input class="form-control" type="number" id="imgRotate" placeholder="Rotate"/>
                </div>
              </div>
            </div>
  
            <div class="panel panel-primary">
              <div class="panel-heading" data-toggle="collapse" data-target="#collapseFilters" ria-expanded="false" aria-controls="collapseFilters">
                <h4 class="panel-title">Filters</h4>
              </div>
              <div class="panel-body collapse" id="collapseFilters">
                <div class="checkbox">
                  <label for="invert">
                    <input type="checkbox" class="filter invert" id="invert" value="invert"/>
                    &nbsp;
                    Invert
                  </label>
                </div>
  
                <div class="checkbox">
                  <label for="grayscale">
                    <input type="checkbox" class="filter grayscale" id="grayscale" value="grayscale"/>
                    &nbsp;
                    Grayscale
                  </label>
                </div>
  
                <div class="checkbox">
                  <label for="sepia">
                    <input type="checkbox" class="filter sepia" id="sepia" value="sepia"/>
                    &nbsp;
                    Sepia  
                  </label>  
                </div>    
                
                <div class="checkbox">
                  <label for="blur">
                    <input type="checkbox" class="filter blur" id="blur" value="blur"/>
                    &nbsp;
                    Blur
                  </label>
                </div>
  
                <div class="checkbox">
                  <label for="noise">
                    <input type="checkbox" class="filter noise" id="noise" value="noise"/>
                    &nbsp;
                    Noise
                  </label>
                </div>
  
                <div class="checkbox">
                  <label for="brightness">
                    <input type="checkbox" class="filter brightness" id="brightness" value="brightness"/>
                    &nbsp;
                    Brightness
                  </label>
                </div>
  
                <div class="checkbox">
                  <label for="blackandwhite">
                    <input type="checkbox" class="filter blackandwhite" id="blackandwhite" value="blackAndWhite"/>
                    &nbsp;
                    Black and white
                  </label>
                </div>
  
                <div class="panel panel-default">
                  <div class="panel-heading">
                    <div class="panel-title">
                      <small>Noise adjustement</small>
                    </div>
                  </div>
                  <div class="panel-body">                  
                    <div class="form-group noise-options">
                      <input type="range" min="1" max="100" id="factor"/>
                    </div>
                  </div>
                </div>
  
                <div class="panel panel-default">
                  <div class="panel-heading">
                    <div class="panel-title">
                      <small>Brightness adjustement</small>
                    </div>
                  </div>
                  <div class="panel-body">                 
                    <div class="form-group brightness-options">
                      <input type="range" min="1" max="100" id="adjustement"/>
                    </div>
                  </div>
                </div>
  
                <div class="panel panel-default">
                  <div class="panel-heading">
                    <div class="panel-title">
                      <small>Black and white adjustement</small>
                    </div>
                  </div>
                  <div class="panel-body">
                    <div class="form-group blackandwhite-options">
                      <input type="range" min="1" max="255" id="threshold"/>
                    </div>
                  </div>
                </div>
              </div>
            </div>   
          </div>
        </div>
        <div class="col-sm-8 col-md-9">
          <div class="panel panel-default">
            <div class="panel-heading">Preview</div>
            <div class="panel-body">
              <canvas id="preview"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script type="text/javascript">
      (function(Global) {
        /*** INIT ***/
        var selectors = [
          'input', '#adjustement', '#factor', '#threshold', 'input#canvasW', 'input#canvasH', 
          'input#imgW', 'input#imgH', 'input#aspectRatio', 'input#imgPosX', 'input#imgPosY',
          'input#ImgRotate', '.filter[type="checkbox"]'
        ];
  
        selectors.forEach(function(selector) {
          onChange(selector, handler)
        });
        onClick('a', download);
        onClick('button#imgPosTop', function() {
          $('#imgPosY').value = 0;
          handler();
        });
        onClick('button#imgPosRight', function() {
          var workSpaceWidth = $('#canvasW').value;
          var imgWidth = $('#imgW').value;
  
          $('#imgPosX').value = workSpaceWidth - imgWidth;
  
          handler();
        });
        onClick('button#imgPosBottom', function() {
          var workSpaceHeight = $('#canvasH').value;
          var imgHeight = $('#imgH').value;
  
          $('#imgPosY').value = workSpaceHeight - imgHeight;
  
          handler();
        });
        onClick('button#imgPosLeft', function() {
          $('#imgPosX').value = 0;
          handler();
        });
        onClick('button#imgPosCenter', function() {
          var workSpaceWidth = $('#canvasW').value;
          var imgWidth = $('#imgW').value;
  
          $('#imgPosX').value = (workSpaceWidth - imgWidth) / 2;
  
          handler();
        });
        onClick('button#imgPosVCenter', function() {
          var workSpaceHeight = $('#canvasH').value;
          var imgHeight = $('#imgH').value;
  
          $('#imgPosY').value = (workSpaceHeight - imgHeight) / 2;
  
          handler();
        })
        /************/
  
        // Filters Algorithm
        Global.Filters = {
          grayscale: function (pixels) {
            var d = pixels.data;
  
            for (var i = 0; i < d.length; i += 4) {
              var r = d[i];
              var g = d[i + 1];
              var b = d[i + 2];
              var v = 0.2126 * r + 0.7152 * g + 0.0722 * b;
  
              d[i] = d[i + 1] = d[i + 2] = v;
            };
  
            return pixels;
          },
          sepia: function (pixels) {
            var d = pixels.data;
  
            for (var i = 0; i < d.length; i += 4) {
              var r = d[i];
              var g = d[i + 1];
              var b = d[i + 2];
              var avg = 0.3 * r + 0.59 * g + 0.11 * b;
  
              d[i] = avg + 100;
              d[i + 1] = avg + 50;
              d[i + 2] = avg;
            };
  
            return pixels;
          },
          invert: function (pixels) {
            var d = pixels.data;
  
            for (var i = 0; i < d.length; i += 4) {
              d[i] = 255 - d[i];
              d[i + 1] = 255 - d[i + 1];
              d[i + 2] = 255 - d[i + 2]
            };
  
            return pixels;
          },
          brightness: function (pixels, adjustement) {
            var d = pixels.data;
  
            for (var i = 0; i < d.length; i += 4) {
              d[i] += adjustement || 40;
              d[i + 1] += adjustement || 40;
              d[i + 2] += adjustement || 40;
            };
  
            return pixels;
          },
          noise: function (pixels, factor) {
            var d = pixels.data;
  
            for (var i = 0; i < d.length; i += 4) {
              var rand = (0.5 - Math.random()) * factor;
              d[i] = d[i] + rand;
              d[i + 1] = d[i + 1] + rand;
              d[i + 2] = d[i + 2] + rand;
            };
  
            return pixels;
          },
          blackAndWhite: function (pixels, threshold) {
            var d = pixels.data;
  
            for (var i = 0; i < d.length; i += 4) {
              var r = d[i];
              var g = d[i + 1];
              var b = d[i + 2];
              var v =
                0.2126 * r + 0.7152 * g + 0.0722 * b >= (threshold || 128) ? 255 : 0;
  
              d[i] = d[i + 1] = d[i + 2] = v;
            };
  
            return pixels;
          },
          blur: function (pixels) {
            var m = [
              [1, 1, 1],
              [1, 1, 1],
              [1, 1, 1]
            ];
  
            return convolve(pixels, m);
          },
          sharpen: function (pixels) {
            var m = [
              [0, -2, 0],
              [-2, 11, -2],
              [0, -2, 0]
            ];
  
            return convolve(pixels, m);
          },
          emboss: function (pixels) {
            var m = [
              [2, 0, 0],
              [0, -1, 0],
              [0, 0, -1]
            ];
  
            return convolve(pixels, m, 127);
          },
          lighten: function (pixels) {
            var m = [
              [0, 0, 0],
              [0, 12, 0],
              [0, 0, 0]
            ];
  
            return convolve(pixels, m);
          },
          darken: function (pixels) {
            var m = [
              [0, 0, 0],
              [0, 6, 0],
              [0, 0, 0]
            ];
  
            return convolve(pixels, m);
          },
          edge: function (pixels) {
            var m = [
              [1, 1, 1],
              [1, -7, 1],
              [1, 1, 1]
            ];
  
            return convolve(pixels, m);
          },
          identity: function (pixels) {
            var m = [
              [0, 0, 0],
              [0, 9, 0],
              [0, 0, 0]
            ];
  
            return convolve(pixels, m);
          }
        }
  
        function convolve(pixels, matrix, offset) {
          var d = pixels.data;
          var len = d.length;
          var m = [].concat(matrix[0], matrix[1], matrix[2]);
          var res = 0;
          var w = pixels.width;
  
          for (var i = 0; i < len; i++) {
            if ((i + 1) % 4 === 0) {
              continue;
            }
  
            res = 0;
            var these = [
              d[i - w * 4 - 4] || d[i],
              d[i - w * 4] || d[i],
              d[i - w * 4 + 4] || d[i],
              d[i - 4] || d[i],
              d[i],
              d[i + 4] || d[i],
              d[i + w * 4 - 4] || d[i],
              d[i + w * 4] || d[i],
              d[i + w * 4 + 4] || d[i]
            ];
  
            for (var j = 0; j < 9; j++) {
              res += these[j] * m[j];
            }
  
            res /= 9;
  
            if (offset) {
              res += offset;
            }
  
            res = Math.min(Math.max(res, 0), 255);
  
            d[i] = res
          }
  
          return pixels;
        };
  
        function slice(args) {
          return Array.prototype.slice.call(args);
        }
  
        function $(selector) {
          return document.querySelector(selector);
        }
  
        function $$(selector) {
          return slice(document.querySelectorAll(selector));
        }
  
        function onChange(selector, cb) {
          $$(selector).forEach(function(el) {
            el.addEventListener('change', cb);
          });
        }
  
        function onClick(selector, cb) {
          $$(selector).forEach(function(el) {
            el.addEventListener('click', cb);
          });
        }
  
        function handler() {
          var $inputsFilterChecked = $$('.filter[type="checkbox"]:checked');
  
          renderImg(function() {
            $inputsFilterChecked.forEach(function($inputFilterChecked) {
              var value = $inputFilterChecked.value;
  
              runFilter(value);
            })
          });
        }
  
        function readFile($input, cb) {       
          if ($input.files && $input.files[0]) {
            var reader = new FileReader();
  
            reader.onload = function(e) {
              cb(e.target.result)
            }
  
            reader.readAsDataURL($input.files[0]);
          }
        }
        
        function runFilter(filter) {
          var $canvas = $('canvas');      
          var ctx = $canvas.getContext('2d');
          var arg = null;
  
          if (filter == 'brightness') {
            var $adjustement = $('#adjustement');
  
            arg = parseInt($adjustement.value, 10);
          } else if (filter == 'blackAndWhite') {
            var $threshold = $('#threshold');
  
            arg = parseInt($threshold.value, 10)
          } else if (filter == 'noise') {
            var $factor = $('#factor');
  
            arg = parseInt($factor.value, 10)
          }
  
          var imgData = filterImage(Filters[filter], arg);
  
          ctx.putImageData(imgData, 0, 0);
        }
  
        function renderImg(cb) {
          var $input = $('input');
  
          readFile($input, function(result) {
            var img = new Image();
  
            img.onload = function() {
              var $inputImgW = $('input#imgW');
              var $inputImgH = $('input#imgH');
              var $inputCanW = $('input#canvasW');
              var $inputCanH = $('input#canvasH');
              var $inputImgPosX = $('input#imgPosX');
              var $inputImgPosY = $('input#imgPosY');
              var $inputImgRatio = $('input#aspectRatio');
              var $inputImgRotate = $('input#imgRotate');
              var ratio = img.height / img.width;
              var w = parseInt($inputImgW.value, 10) || img.width;
              var h = parseInt($inputImgH.value, 10) || img.height;
              var cw = parseInt($inputCanW.value, 10) || img.width;
              var ch = parseInt($inputCanH.value, 10) || img.height; 
              var x = parseInt($inputImgPosX.value, 10) || 0;
              var y = parseInt($inputImgPosY.value, 10) || 0;   
              var angle = parseInt($inputImgRotate.value, 10) || 0;   
              var c = getCanvas(cw, ch);
              var ctx = c.getContext('2d');
  
              if ($inputImgRatio.checked) {
                h = w * ratio;
              }
  
              $inputImgW.value = w;
              $inputImgH.value = h;
              $inputCanW.value = cw;
              $inputCanH.value = ch;
              $inputImgPosX.value = x;
              $inputImgPosY.value = y;
  
              if (angle !== 0) {
                ctx.translate(c.width/2, c.height/2)
                ctx.rotate(angle*Math.PI / 180);
                ctx.drawImage(img, (x - w/2), (y - h/2), w, h);
              } else {
                ctx.drawImage(img, x, y, w, h);
              }
              if (cb) cb();
            }
  
            img.src = result;
          })
        }
  
        function getPixels() {
          var $canvas = $('canvas');
          var ctx = $canvas.getContext('2d');
  
          return ctx.getImageData(0,0, $canvas.width, $canvas.height);
        }
  
        function getCanvas(w, h) {
          var c = $('canvas');
          
          c.width = w;
          c.height = h;
  
          return c;
        }
  
        function filterImage(filter, var_args) {
          var args = [getPixels()];
  
          for(var i = 1; i < arguments.length; i++) {
            args.push(arguments[i]);
          }
  
          return filter.apply(null, args);
        }
  
        function download() {
          var $canvas = $('canvas');
  
          $link.href = $canvas.toDataURL('image/png');
          $link.download = 'output.png'
        }
      }(window));
    </script>
  </body>
</html>